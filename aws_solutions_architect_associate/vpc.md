# Virtual Private Cloud - VPC

- Consists primarily:
  - Internet Gateway
  - Routing tables
  - Network access control lists (NACLS)
  - Security groups
  - Subnets
- 1 Subnet == 1 AZ
- No transitive peering (A --> B --> C, C can talk to B but not to A, it needs to be have it's own peering)
- Security groups are stateful, while NACLS are stateless.
- Bigest network segment is `/16`, the smallest is `/28`
- **Amazon reserves 5 IP address by subnet**
- **When you create VPC by default:**
  - a default route table, network access control list (NACL) and security group are created
  - No subnets will be created
  - Availability zones can be different in another AWS account (ZONE ID)
- **You can have only 1 Internet gateway per VPC**
- **Security groups belong to one VPC only.**
- **SG ARE STATEFUL; NACLS ARE STATELESS**
- **The purpose of an "Egress-Only Internet Gateway" is to allow IPv6 based traffic within a VPC to access the Internet, whilst denying any Internet based resources the possibility of initiating a connection back into the VPC.**
- **If you decide to use `Dedicated hosting tenancy`, you can go back via CLI or API.**

# NACLs

- **VPC automatically creates a default NACL. by default allows all ingress/egress traffic.**
- **You can create custom NACL's, but by default custom NACLs denied all inbound/outbound traffic**
- **Each subnet in VPC should be associated with a NACL. If you dont' associate your subnet by default uses the default NACL.**
- **You can block IP address in NACL, not in a SG.**
- **You can associate multiple subnet with a NACL. If you associate the subnet with a new NACL, the previous association is removed.**
- **NACLs rules are evaluated in order from top to bottom (lowest to highest number)**
- **NACLs have separate inbound/outbound rules.**
- **NACLs are stateless, response to allowed inbound traffic are subjet to rules for outbound traffic and vice versa.**


# NAT Gateway - NAT Instance

- NAT instances:
  - **If using a NAT instance we need to disable source/destination check on the instance.**
  - NAT instance must be in public subnet.
  - There must be a route to `0.0.0.0/0` pointed to the NAT instance
  - Traffic the NAT instance can support/throughput depends on the instance type
  - If you want HA you need to do handle it by yourself (Autoscaling, scripts, etc)

- NAT Gateways:
  - They have HA builtin within the AZ
  - 1 NAT gateway per AZ
  - Throughtput is 5GBps up to 45GBps
  - Enterprise ready
  - AWS managed this service
  - Not associated with any SG
  - Automatically assigned EIP
  - You need to update route tables to point `0.0.0.0/0` to the NAT Gateway.
  - Create a NAT gateway per AZ in case of zone failure you don't loose internet connectivity

# VPC FlowLogs

- You cannot enable flow logs for VPC that are peered with your VPC.
- You cannot tag a flow log
- Once you have created a flow log, you cannot change the configuration. for example; you can't associate a different IAM role to flow log.
- **Not all IP traffic is monitored**
  - Traffic generated by AWS instances when they connect to Amazon DNS resolver.
  - Traffic generated by Windows instance for Amazon Windows License activation.
  - Traffic to/from 169.254.169.265 for instance metadata.
  - DHCP Traffic
  - Traffic to reserved instances for default VPC router

# Bastion Hosts

- Nat instance/Nat gateways are used to provider internet traffic to EC2 instances in private subnets.
- A bastion host/jumphost is used to connect to other instances (SSH/RDP)
- You cannot use a NAT Gateway as bastion host.

# Direct Connect

- DirectConnect connects your datacenter directly with AWS
- Useful for high throughput workloads (network)
- If you need a stable and reliable secure connection

# VPC Endpoints

- Connect instances with other services through internal network (not going through nat gateway/internet gateway)
- Two types of VPC endpoints:
  - **Interface endpoints: is an elastic network interface with private IP address that serves as entry point to traffic destined to
    a supported service.
  - Gateway endpoints (S3, DynamoDB)
-


# References

- https://docs.aws.amazon.com/vpc/latest/userguide/VPC_Subnets.html
- https://docs.aws.amazon.com/vpc/latest/userguide/VPC_NAT_Instance.html
- https://docs.aws.amazon.com/vpc/latest/userguide/vpc-network-acls.html#nacl-ephemeral-ports